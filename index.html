<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Pac-Squirrel</title>
<style>
  :root {
    --tile: 24px;            /* logical tile size – canvas will upscale on Hi-DPI */
    --maze-w: calc(var(--tile) * 28);
    --maze-h: calc(var(--tile) * 31);
  }
  * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body {
    margin:0; padding:0; height:100%; width:100%; background:#000; color:#fff;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    font-family:Arial,Helvetica,sans-serif;
    touch-action:none;
  }
  #game {
    image-rendering:pixelated; /* crispy retro look */
    background:#000;
    width:100vw; max-width:600px; height:auto;
  }
  #ui {
    width:100%; max-width:600px; display:flex; flex-direction:column; align-items:center; gap:12px; padding:10px 0 40px;
  }
  .dpad { display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:8px; width:180px; }
  .key {
    width:56px; height:56px; background:#222; border:2px solid #555; border-radius:12px; display:flex; align-items:center; justify-content:center;
    font-size:28px; line-height:1; color:#fff;
  }
  .key:active { background:#444; }
  input[type="range"] { width:60%; }
  label { font-size:14px; }
</style>
</head>
<body>
<canvas id="game" width="672" height="744"></canvas>
<div id="ui">
  <div class="dpad">
    <div></div><button class="key" id="btnUp">▲</button><div></div>
    <button class="key" id="btnLeft">◄</button><div></div><button class="key" id="btnRight">►</button>
    <div></div><button class="key" id="btnDown">▼</button><div></div>
  </div>
  <label>Speed <input id="speed" type="range" min="1" max="10" value="5"></label>
</div>
<script>
/*****************  CONFIG  *****************/
const TILE = 24;                        // logical tile size in px
const ROWS = 31, COLS = 28;             // classic Pac-Man maze
const BASE_INTERVAL = 200;              // ms when speed = 1
const SPRITE_SRC = 'sprites.png';       // <-- download generated sprite sheet and put here
/********************************************/
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;

// Resize for Hi-DPI
const scale = window.devicePixelRatio || 1;
canvas.width  = COLS * TILE * scale;
canvas.height = ROWS * TILE * scale;
ctx.scale(scale, scale);

const sprite = new Image();
sprite.src = SPRITE_SRC;

// Map legend: # wall, . pellet, o power-pellet, ' ' empty
const MAZE = [
  '############################',
  '#............##............#',
  '#.####.#####.##.#####.####.#',
  '#o####.#####.##.#####.####o#',
  '#.####.#####.##.#####.####.#',
  '#..........................#',
  '#.####.##.########.##.####.#',
  '#.####.##.########.##.####.#',
  '#......##....##....##......#',
  '######.##### ## #####.######',
  '######.##### ## #####.######',
  '######.##          ##.######',
  '######.## ######## ##.######',
  '######.## ######## ##.######',
  '#............##............#',
  '#.####.#####.##.#####.####.#',
  '#.####.#####.##.#####.####.#',
  '#o..##................##..o#',
  '###.##.##.########.##.##.###',
  '###.##.##.########.##.##.###',
  '#......##....##....##......#',
  '#.##########.##.##########.#',
  '#.##########.##.##########.#',
  '#..........................#',
  '############################'
];

const pellets = new Set();
MAZE.forEach((row, r) => {
  [...row].forEach((ch, c) => {
    if (ch === '.' || ch === 'o') pellets.add(r + ',' + c);
  });
});

const DIRS = {LEFT:[-1,0], RIGHT:[1,0], UP:[0,-1], DOWN:[0,1]};
function canMove(x,y){
  const c = Math.round(x), r = Math.round(y);
  return MAZE[r]?.[c] !== '#';
}
class Entity {
  constructor(x,y,frames){
    this.x=x; this.y=y; this.dir='LEFT'; this.nextDir='LEFT'; this.frames=frames; this.frameIx=0;
  }
  tryTurn(){
    const [dx,dy]=DIRS[this.nextDir];
    if(canMove(this.x+dx,this.y+dy)) this.dir=this.nextDir;
  }
  step(){
    this.tryTurn();
    const [dx,dy]=DIRS[this.dir];
    if(canMove(this.x+dx,this.y+dy)){ this.x+=dx; this.y+=dy; }
    // tunnel wrap
    if(this.x<0) this.x=COLS-1; if(this.x>=COLS) this.x=0;
    this.frameIx = (this.frameIx+1)%this.frames[this.dir].length;
  }
  draw(){
    const [sx,sy] = this.frames[this.dir][this.frameIx];
    ctx.drawImage(sprite,sx,sy,32,32,this.x*TILE,this.y*TILE,TILE,TILE);
  }
}

// Player squirrel frames (row 0: right,left,up,down)
const sqFrames = {
  RIGHT:[[0,0]], LEFT:[[32,0]], UP:[[64,0]], DOWN:[[96,0]]
};
// Ghost bat frames (rows 1 & 2) – wing up/down per color
const batFrames = color => ({
  LEFT:[[0,32+color*64],[0,64+color*64]], RIGHT:[[32,32+color*64],[32,64+color*64]], UP:[[64,32+color*64],[64,64+color*64]], DOWN:[[96,32+color*64],[96,64+color*64]]
});

const player = new Entity(13,23,sqFrames);
const ghosts=[0,1,2,3].map(i=>new Entity(13,11,batFrames(i)));

function ghostAI(g){
  // naïve random at intersections
  const choices=['LEFT','RIGHT','UP','DOWN'].filter(d=>{
    const [dx,dy]=DIRS[d];
    return canMove(Math.round(g.x)+dx,Math.round(g.y)+dy);
  });
  if(choices.length>0 && Math.random()<0.3) g.dir=choices[Math.random()*choices.length|0];
  g.step();
}

function eatPellets(){
  const key=Math.round(player.y)+','+Math.round(player.x);
  pellets.delete(key);
}
function drawMaze(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#001c3c';
  MAZE.forEach((row,r)=>{ [...row].forEach((ch,c)=>{ if(ch==='#') ctx.fillRect(c*TILE,r*TILE,TILE,TILE); }); });
  ctx.fillStyle='#ffd';
  pellets.forEach(k=>{ const [r,c]=k.split(',').map(Number); ctx.fillRect(c*TILE+TILE*0.4,r*TILE+TILE*0.4,TILE*0.2,TILE*0.2); });
}

let interval = BASE_INTERVAL/5; // will be updated by speed slider
let timer = 0;
function gameLoop(ts){
  if(ts - timer >= interval){
    player.step();
    eatPellets();
    ghosts.forEach(ghostAI);
    timer = ts;
  }
  drawMaze();
  player.draw(); ghosts.forEach(g=>g.draw());
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

/**************  INPUT  ****************/ 
function setDir(d){ player.nextDir=d; }
['Up','Down','Left','Right'].forEach(dir=>{
  document.getElementById('btn'+dir).addEventListener('pointerdown',()=>setDir(dir.toUpperCase()));
});
window.addEventListener('keydown',e=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
    e.preventDefault();
    setDir(e.key.replace('Arrow','').toUpperCase());
  }
});

document.getElementById('speed').addEventListener('input',e=>{
  const v=+e.target.value; interval = BASE_INTERVAL / v;
});
</script>
</body>
</html>
