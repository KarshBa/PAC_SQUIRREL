<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Pac‑Squirrel</title>
<style>
  :root { --tile:24px; }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  html,body{margin:0;padding:0;height:100%;width:100%;background:#000;color:#fff;display:flex;flex-direction:column;align-items:center;font-family:Arial,Helvetica,sans-serif;}
  #game{image-rendering:pixelated;background:#000;width:100vw;max-width:600px;height:auto;}
  #score{font-size:18px;margin:6px 0;}
  #ui{width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center;gap:12px;padding-bottom:40px;}
  .dpad{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:8px;width:180px;}
  .key{width:56px;height:56px;background:#222;border:2px solid #555;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;}
  .key:active{background:#444;}
  input[type=range]{width:60%;}
  label{font-size:14px;}
  #menu{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center;}
  #menu h1{font-size:48px;margin:0;color:#ffcf4a;text-shadow:0 0 6px #ffcf4a;}
  #menu p{margin:0;font-size:20px;}
  #startBtn{font-size:24px;padding:12px 28px;border:none;border-radius:8px;background:#ffcf4a;color:#000;cursor:pointer;}
  #startBtn:active{background:#ffc500;}
</style>
</head>
<body>
<canvas id="game" width="672" height="744"></canvas>
<div id="score">Score: 0</div>
<div id="ui">
  <div class="dpad">
    <div></div><button class="key" id="btnUp">▲</button><div></div>
    <button class="key" id="btnLeft">◄</button><div></div><button class="key" id="btnRight">►</button>
    <div></div><button class="key" id="btnDown">▼</button><div></div>
  </div>
  <label>Speed <input id="speed" type="range" min="1" max="10" value="5"></label>
</div>
<div id="menu"><h1>Pac‑Squirrel</h1><p id="menuMsg"></p><button id="startBtn">START</button></div>

<script>
/******** CONFIG ********/
const TILE = 24,
      ROWS = 31,
      COLS = 28,
      BASE_INTERVAL = 200,         // ms at speed slider = 1
      SPRITE_SRC   = 'sprites_n64.png';
/************************/

const canvas = document.getElementById('game');
const ctx     = canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled = false;

// Hi‑DPI support
const scale = window.devicePixelRatio || 1;
canvas.width  = COLS * TILE * scale;
canvas.height = ROWS * TILE * scale;
ctx.scale(scale,scale);

// Load sprite sheet
const sprite = new Image();
sprite.src = SPRITE_SRC;
sprite.crossOrigin = 'anonymous';
sprite.onerror = () => console.error('Sprite failed to load – check filename/path');

/******** MAZE *********/
const MAZE = [
'############################',
'#............##............#',
'#.####.#####.##.#####.####.#',
'#o####.#####.##.#####.####o#',
'#.####.#####.##.#####.####.#',
'#..........................#',
'#.####.##.########.##.####.#',
'#.####.##.########.##.####.#',
'#......##....##....##......#',
'######.##### ## #####.######',
'######.##### ## #####.######',
'######.##          ##.######',
'######.## ######## ##.######',
'######.## ######## ##.######',
'#............##............#',
'#.####.#####.##.#####.####.#',
'#.####.#####.##.#####.####.#',
'#o..##................##..o#',
'###.##.##.########.##.##.###',
'###.##.##.########.##.##.###',
'#......##....##....##......#',
'#.##########.##.##########.#',
'#.##########.##.##########.#',
'#..........................#',
'############################'
];

let pellets, score;
function resetPellets(){
  pellets = new Set();
  MAZE.forEach((row,r)=>{
    [...row].forEach((ch,c)=>{
      if(ch==='.'||ch==='o') pellets.add(r+','+c);
    });
  });
  score = 0;
  document.getElementById('score').textContent = 'Score: 0';
}

/******** MOVEMENT & ENTITIES ********/
const DIRS = {LEFT:[-1,0],RIGHT:[1,0],UP:[0,-1],DOWN:[0,1]};
function canMove(x,y){
  const c=Math.round(x), r=Math.round(y);
  return MAZE[r]?.[c] !== '#';
}

class Entity{
  constructor(x,y,frames){
    this.x=x; this.y=y;
    this.dir='LEFT';
    this.nextDir='LEFT';
    this.frames=frames;
    this.f=0;
  }
  tryTurn(){
    const [dx,dy]=DIRS[this.nextDir];
    if(canMove(this.x+dx,this.y+dy)) this.dir=this.nextDir;
  }
  step(){
    this.tryTurn();
    const [dx,dy] = DIRS[this.dir];
    if(canMove(this.x+dx,this.y+dy)){ this.x+=dx; this.y+=dy; }
    if(this.x<0) this.x = COLS-1;
    if(this.x>=COLS) this.x = 0;
    this.f = (this.f+1) % this.frames[this.dir].length;
  }
  draw(){
    const [sx,sy] = this.frames[this.dir][this.f];
    ctx.drawImage(sprite,sx,sy,32,32,this.x*TILE,this.y*TILE,TILE,TILE);
  }
}

// Sprite frames
const sqFrames = {
  RIGHT:[[0,0]],
  LEFT :[[32,0]],
  UP   :[[64,0]],
  DOWN :[[96,0]]
};
const batFrames = c=>{
  const y = (1+c)*32;
  const row = [[0,y],[32,y],[64,y],[96,y]];
  return {LEFT:row,RIGHT:row,UP:row,DOWN:row};
};

// Entities
let player, ghosts;
function resetEntities(){
  player = new Entity(13,23,sqFrames);
  ghosts = [0,1,2,3].map(i=>new Entity(13+i%2,11+(i/2|0),batFrames(i)));
}

/******** GAME STATE ********/
let interval     = BASE_INTERVAL/5,
    timer        = 0,
    state        = 'menu',      // 'menu' | 'playing' | 'win' | 'lose'
    startTime    = 0;

/******** CORE FUNCTIONS ********/
function eat(){
  const key = Math.round(player.y)+','+Math.round(player.x);
  if(pellets.delete(key)){
    score++;
    document.getElementById('score').textContent = 'Score: '+score;
    if(pellets.size===0) endGame('win');
  }
}
function checkCollisions(){
  const px=Math.round(player.x), py=Math.round(player.y);
  for(const g of ghosts){
    if(Math.round(g.x)===px && Math.round(g.y)===py){
      endGame('lose');
      break;
    }
  }
}
function ghostAI(g){
  const options = ['LEFT','RIGHT','UP','DOWN'].filter(d=>{
    const [dx,dy]=DIRS[d];
    return canMove(Math.round(g.x)+dx,Math.round(g.y)+dy);
  });
  if(options.length && Math.random()<0.25){
    g.dir = options[Math.random()*options.length|0];
  }
  g.step();
}
function drawMaze(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#001c3c';
  MAZE.forEach((row,r)=>{
    [...row].forEach((ch,c)=>{
      if(ch==='#') ctx.fillRect(c*TILE,r*TILE,TILE,TILE);
    });
  });
  ctx.fillStyle='#ffd';
  pellets.forEach(k=>{
    const [r,c]=k.split(',').map(Number);
    ctx.fillRect(c*TILE+TILE*0.4,r*TILE+TILE*0.4,TILE*0.2,TILE*0.2);
  });
}

/******** GAME LOOP ********/
function gameLoop(ts){
  if(state==='playing' && ts-timer>=interval){
    player.step();
    eat();
    ghosts.forEach(ghostAI);
    checkCollisions();
    timer = ts;
  }
  drawMaze();
  player.draw();
  ghosts.forEach(g=>g.draw());
  requestAnimationFrame(gameLoop);
}

/******** MENU & FLOW ********/
function startGame(){
  document.getElementById('menu').style.display='none';
  resetPellets();
  resetEntities();
  state='playing';
  startTime = performance.now();
  timer = 0;
}
function endGame(result){
  state = result; // 'win' or 'lose'
  const menu = document.getElementById('menu');
  const msg  = document.getElementById('menuMsg');
  const btn  = document.getElementById('startBtn');
  btn.textContent = 'PLAY AGAIN';
  if(result==='win'){
    const t = ((performance.now()-startTime)/1000).toFixed(2);
    msg.textContent = `You win!  Time: ${t}s`;
  }else{
    msg.textContent = 'You were caught!';
  }
  menu.style.display='flex';
}

/******** INPUT ********/
function setDir(d){ player.nextDir = d; }
['Up','Down','Left','Right'].forEach(dir=>{
  document.getElementById('btn'+dir).addEventListener('pointerdown',()=>setDir(dir.toUpperCase()));
});
window.addEventListener('keydown',e=>{
  const map = {'ArrowUp':'UP','ArrowDown':'DOWN','ArrowLeft':'LEFT','ArrowRight':'RIGHT'};
  if(map[e.key]){ e.preventDefault(); setDir(map[e.key]); }
  if(state==='menu' && (e.key===' '||e.key==='Enter')) startGame();
});
document.getElementById('speed').addEventListener('input',e=>{
  interval = BASE_INTERVAL / +e.target.value;
});
document.getElementById('startBtn').addEventListener('click',startGame);

/******** START ********/
sprite.onload = ()=> requestAnimationFrame(gameLoop);
</script>
</body>
</html>
